# Minnebar Scheduling
The process to generate a schedule for Minnebar takes time, and involves many steps and people.

### Rough timeline
* **1 week out**: Start gathering presenter time constraints
* **4 days out**: Generate draft schedule (This process)
* **3 days out**: Finalize schedule
* **2 days out**: Assign rooms
* **1 day out**: Field last minute cancelations + schedule and room requests.
* **Day of event**: Minnebar


# Scheduling how-tos
Instructions on how to generate a schedule for Minnebar.

### TL;DR:

1. Pull latest prod data
2. Set timeslots
3. Gather schedule constraints
4. Generate schedule
5. Upload schedule to prod

----

## 1. Pull latest prod data
```bash
src/bin/pull-database-from-production
```

## 2. Set timeslots
Update and/or generate time slots.

Spot check them under `task :create_timeslots` in `app.rake` before running:
```bash
# local
bundle exec rails app:create_timeslots

# prod
heroku run rails app:create_timeslots
```

After running, spot check them again. Even though there are no sessions on the schedule yet, you can view the timeslots at:

* **Local**: http://127.0.0.1:3000/schedule?preview=1
* **Prod**: https://sessions.minnestar.org/schedule?preview=1

**Note**: You must be logged in (using prod credentials) to view the page.


**Note**: Manually editing timeslots via the admin panel is possible at:
https://sessions.minnestar.org/admin/events/{EVENT_ID}/timeslots

## 3. Gather schedule constraints
You'll need to gether presenter/session scheduling constraints and save them to a csv file for this step.

See `task :configure_sessions` in `app.rake` for documentation on the csv file and format.

**Important notes**:
* Ideally this process has started at least a few days in advance.
* Importing constraints needs to happen _before_ the schedule gets generated.
* If time constraint requests come through _after_ a schedule has been set, you'll want to "freeze" the other sessions (manually via the rails console). Paul has a recipe for this.


## 4. Generate the schedule
The `bin/schedule` script will carry out the entire schedule generation process, given a constraints file as input. It will output a generated schedule to the file name you specify.

The steps are:

  1. Pull prod data
  2. Analyze schedule quality
  3. Read scheduling constraints
  4. Generate & refine schedule
  5. Export the schedule

To run the script:
```bash
bin/schedule path/to/schedule-constraints.csv path/to/save-schedule-export.json
```
Once generated, you can access a preview at.
* **Local**: http://127.0.0.1:3000/schedule?preview=1
* **Prod**: https://sessions.minnestar.org/schedule?preview=1

**Note**: You must be logged in (using prod credentials) to view the page.
## 5. Upload the schedule
Once the schedule looks good, you can upload it to prod:
```bash
heroku run rails app:import_schedule < path/to/exported-schedule-file.json
```

## 6. Assigning rooms (happens later)
This typically doesn't happen until the day before the event.

* Available rooms are statically defined under `task :create_rooms` in `app.rake`.
* Reassigning rooms is much easier than reassigning time slots.

# Other notes

## How to read the generate schedule output
Every time you run the rake task, the output will change. But it starts from the best one from the previous run when it starts.
```
bundle exec rails app:generate_schedule
```

In the very long output, lines that look like this are meaningful:

>  Schedule
  | quality vs. random = 85.750% (0% is no better than random; 100% is unachievable; > 50% is good)
  | absolute satisfaction = 94.857% of impossibly perfect schedule
  | presenter score = 100.000% (if < 100 then presenters have conflicts)

## Additional scripts & tasks
`app.rake` contains a long list of rake tasks and documentation you may find helpful:

```bash
rake app:analyze_scheduler_input_quality    # print a summary of data that will affect the quality of...
rake app:assign_rooms                       # assign scheduled sessions to rooms
rake app:clear_schedule                     # clear the current schedule (DANGER: Irreversible
rake app:configure_sessions[config_file]    # read schedule constraints and session deletions from a ...
rake app:create_remote_timeslots_and_rooms  # set up multi-day timeslots for a remote event
rake app:create_rooms                       # create default rooms for most recent event
rake app:create_timeslots                   # create default timeslots for the most recent event
rake app:export_schedule                    # export schedule for import to another node (for running...
rake app:generate_schedule                  # Create a schedule for the current event
rake app:import_schedule                    # import schedule generated by app:export_schedule
rake app:make_believe                       # Reset and hydrate the database with dummy data
rake app:presentationize                    # add a Presentation for each Session with the session ow...
rake app:presenter                          # add a presenter to a session
rake app:show_restrictions                  # show restrictions for current event
rake app:template                           # Applies the template supplied by LOCATION=(/path/to/tem...
rake app:update                             # Update configs and some other initially generated files...
```

For the most current list, run `rake -T`.